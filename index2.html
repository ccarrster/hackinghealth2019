<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-3.4.1.min.js"></script>
	<script src="js/load-image.all.min.js"></script>
	<script>
		function suggestEvent(){
			$('#content').html('<form><div><div>Website</div><div><input id="website" type="text" name="website"></div><div>Description</div><div><textarea id="description" name="description"></textarea></div><div>How did you find out about this event</div><div><textarea id="find" name="find"></textarea></div><div>Image</div><div><input id="fileBox" name="image" type="file"></div><div><input type="button" value="submit" onclick="suggestioncreated();"></div><div><input type="button" value="cancel" onclick="$(\'#content\').html(\'\');"></div></div></form>');
		}
		function getFile(filename){
			var description = $('#description').val();
			var website = $('#website').val();
			var find = $('#find').val();
			var imagepath = '';
			$.post('api.php', {action: 'suggestevent', description: description, website: website, find: find, imagepath: filename}, suggestiondone);
		}

		function suggestiondone(){
			$('#content').html('Thanks for the event suggestion.');
		}

		function suggestioncreated(){
			var file = document.getElementById('fileBox').files[0]; //Files[0] = 1st file
			if (file !== undefined) {
				shipOff();
			} else {
				getFile('');
			}
		}
		//reader.onloadstart = ...
		//reader.onprogress = ... <-- Allows you to update a progress bar.
		//reader.onabort = ...
		//reader.onerror = ...
		//reader.onloadend = ...

		function uploaddone(data){
			var result = JSON.parse(data);
			getFile(result.serverFile);
		}


		function shipOff() {
			var $data = new FormData();
		    $data.append('title', 'Sample Photo Title');
		    $data.append('file', $("#fileBox").get(0).files[0]);

			// processData & contentType should be set to false
		    $.ajax({
		        type: 'POST',
		        url: 'upload.php',
		        data: $data,
		        success: function(response) {

		        },
		        error: function(response) {

		        },
		        processData: false,
		        contentType: false
		    });
		}

		function reviewEvents(){
			$.post('api.php', { action: 'reviewevents'}, reviewloaded);
		}
		var funArr = [];
		function reviewloaded(data){
			var suggestions = JSON.parse(data);
			for(suggestionKey in suggestions){
				eval("funArr[suggestionKey] = function(img, data){$('#image"+suggestionKey+"').html(img);}");
			}
			console.log(funArr);
			var reviewString = '';
			for(suggestionKey in suggestions){
				var suggestion = suggestions[suggestionKey];
				reviewString += '<div>';
				reviewString += 'Description: '+suggestion.description;
				reviewString += '</div>';
				reviewString += '<div>';
				reviewString += 'Website: '+suggestion.website;
				reviewString += '</div>';
				if(suggestion.imagepath != ''){
					reviewString += '<div>';
					reviewString += '<a id="image'+suggestionKey+'" href="uploads/'+suggestion.imagepath+'" target="_blank">';
					loadImage(
						"uploads/" + suggestion.imagepath,
						eval('funArr['+suggestionKey+']'),
						{ meta: true, orientation: true, maxWidth: 200, maxHeight: 200}
					);
					reviewString += '</a>';
					reviewString += '</div>';
				}
			}
			$('#content').html(reviewString);
		}


	</script>
	<style>
	</style>
</head>
<body>
	<div id="menu">
		<input type="button" value="Suggest Event" onclick="suggestEvent();">
		<input type="button" value="Review Suggested Events" onclick="reviewEvents();">
	</div>
	<div id="content">
	</div>
</body>
</html>