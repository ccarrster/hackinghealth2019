<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-3.4.1.min.js"></script>
	<script src="js/load-image.all.min.js"></script>
	<script>
		function suggestEvent(){
			$('#content').html('<form><div><div>Website</div><div><input id="website" type="text" name="website"></div><div>Description</div><div><textarea id="description" name="description"></textarea></div><div>How did you find out about this event</div><div><textarea id="find" name="find"></textarea></div><div>Image</div><div><input id="fileBox" name="image" type="file"></div><div><input type="button" value="submit" onclick="suggestioncreated();"></div><div><input type="button" value="cancel" onclick="$(\'#content\').html(\'\');"></div></div></form>');
		}
		function getFile(filename){
			var description = $('#description').val();
			var website = $('#website').val();
			var find = $('#find').val();
			var imagepath = '';
			$.post('api.php', {action: 'suggestevent', description: description, website: website, find: find, imagepath: filename}, suggestiondone);
		}

		function suggestiondone(){
			$('#content').html('Thanks for the event suggestion.');
		}

		function suggestioncreated(){
			var file = document.getElementById('fileBox').files[0]; //Files[0] = 1st file
			if (file !== undefined) {
				shipOff();
			} else {
				getFile('');
			}
		}
		//reader.onloadstart = ...
		//reader.onprogress = ... <-- Allows you to update a progress bar.
		//reader.onabort = ...
		//reader.onerror = ...
		//reader.onloadend = ...

		function uploaddone(result){
			getFile(result.serverFile);
		}


		function shipOff() {
			var $data = new FormData();
		    $data.append('title', 'Sample Photo Title');
		    $data.append('file', $("#fileBox").get(0).files[0]);

			// processData & contentType should be set to false
		    $.ajax({
		        type: 'POST',
		        url: 'upload.php',
		        data: $data,
		        success: uploaddone,
		        error: function(response) {
					console.log(response);
		        },
		        processData: false,
		        contentType: false
		    });
		}
		var suggestions = null;
		function reviewEvents(){
			$.post('api.php', { action: 'reviewevents'}, reviewloaded);
		}
		var funArr = [];
		function reviewloaded(data){
			suggestions = JSON.parse(data);
			for(suggestionKey in suggestions){
				eval("funArr[suggestionKey] = function(img, data){$('#image"+suggestionKey+"').html(img);}");
			}
			var reviewString = '';
			for(suggestionKey in suggestions){
				var suggestion = suggestions[suggestionKey];
				reviewString += '<div class="suggestion">';
				reviewString += '<div>';
				reviewString += 'Description: '+suggestion.description;
				reviewString += '</div>';
				reviewString += '<div>';
				reviewString += 'Website: <a target="_blank" href="'+suggestion.website+'">'+suggestion.website+'</a>';
				reviewString += '</div>';
				if(suggestion.imagepath != ''){
					reviewString += '<div>';
					reviewString += '<a id="image'+suggestionKey+'" href="uploads/'+suggestion.imagepath+'" target="_blank">';
					loadImage(
						"uploads/" + suggestion.imagepath,
						eval('funArr['+suggestionKey+']'),
						{ meta: true, orientation: true, maxWidth: 200, maxHeight: 200}
					);
					reviewString += '</a>';
					reviewString += '</div>';
				}
				reviewString += '<div>';
				reviewString += '<input type="button" value="Create Event" onclick="startEvent('+suggestionKey+')">';
				reviewString += '<input type="button" value="Duplicate Event" onclick="duplicateEvent('+suggestionKey+')">';
				reviewString += '<input type="button" value="Invalid Event" onclick="invalidEvent('+suggestionKey+')">';
				reviewString += '<input type="button" value="Incomplete Event" onclick="incompleteEvent('+suggestionKey+')">';
				reviewString += '</div>';
				reviewString += '</div>';
			}
			if(reviewString == ''){
				reviewString = 'No more new events to review. Go find and suggest some more!';
			}
			$('#content').html(reviewString);
		}

		function getSuggestionString(suggestionKey){
			reviewString = '';
			var suggestion = suggestions[suggestionKey];
			reviewString += '<div class="suggestion">';
			reviewString += '<div>';
			reviewString += 'Description: '+suggestion.description;
			reviewString += '</div>';
			reviewString += '<div>';
			reviewString += 'Website: <a target="_blank" href="'+suggestion.website+'">'+suggestion.website+'</a>';
			reviewString += '</div>';
			if(suggestion.imagepath != ''){
				reviewString += '<div>';
				reviewString += '<a id="image'+suggestionKey+'" href="uploads/'+suggestion.imagepath+'" target="_blank">';
				loadImage(
					"uploads/" + suggestion.imagepath,
					eval('funArr['+suggestionKey+']'),
					{ meta: true, orientation: true, maxWidth: 200, maxHeight: 200}
				);
				reviewString += '</a>';
				reviewString += '</div>';
			}
			reviewString += '<div>';
			reviewString += '<input type="button" value="Create Event" onclick="startEvent('+suggestionKey+')">';
			reviewString += '<input type="button" value="Duplicate Event" onclick="duplicateEvent('+suggestionKey+')">';
			reviewString += '<input type="button" value="Invalid Event" onclick="invalidEvent('+suggestionKey+')">';
			reviewString += '<input type="button" value="Incomplete Event" onclick="incompleteEvent('+suggestionKey+')">';
			reviewString += '</div>';
			reviewString += '</div>';
			return reviewString;
		}

		function startEvent(suggestionId){
			var eventString = '';
			eventString += getSuggestionString(suggestionId);
			$('#content').html(eventString);
		}

		function duplicateEvent(suggestionId){
			$.post('api.php', {action: 'suggestionstatusupdate', id: suggestionId, status: 'duplicate'}, reviewEvents);
		}

		function invalidEvent(suggestionId){
			$.post('api.php', {action: 'suggestionstatusupdate', id: suggestionId, status: 'invalid'}, reviewEvents);
		}

		function incompleteEvent(suggestionId){
			$.post('api.php', {action: 'suggestionstatusupdate', id: suggestionId, status: 'incomplete'}, reviewEvents);
		}

	</script>
	<style>
		.suggestion{
			border: 1px solid black;
			padding: 10px;
			margin: 10px;
		}
	</style>
</head>
<body>
	<div id="menu">
		<input type="button" value="Suggest Event" onclick="suggestEvent();">
		<input type="button" value="Review Suggested Events" onclick="reviewEvents();">
	</div>
	<div id="content">
	</div>
</body>
</html>